<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
    <meta http-equiv="Content-Language" content="zh-CN" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- 360 -->
    <meta name="360-site-verification" content="fa6ca3a9a0330e9cecabee0a9fe1d52a" />
    <!-- 搜狗 -->
    <meta name="sogou_site_verification" content="oatSp9uAV5" />
    <!--熊掌号 -->
    <meta name="baidu-site-verification" content="Wkb0Jzk8yx" />
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="IJrXvaK-Luj-lCGP7tymcCbkcfMKi82Y8V21qN9ZT0s" />
    <title>
        
            JavaScript 事件循环
        
    </title>
    <link rel="shortcut icon" type="image/x-icon" href="/assets/img/favicon.ico">
    
    <link rel="stylesheet" href="/assets/css/materialize.min.css">
    <link rel="stylesheet" href="/assets/css/icons.css">
    

    
        
        <link rel="stylesheet" href="/assets/css/page.css">
        
    
        
        <link rel="stylesheet" href="/assets/css/post.css">
        
    
        
        <link rel="stylesheet" href="/assets/css/syntax.css">
        
    
        
        <link rel="stylesheet" href="/assets/css/article-category.css">
        
    

    
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">	
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="JavaScript 事件循环" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="JavaScript 运行机制以及堆栈的详细描述" />
<meta property="og:description" content="JavaScript 运行机制以及堆栈的详细描述" />
<link rel="canonical" href="http://localhost:4000/2019/06/20/js-event-loop" />
<meta property="og:url" content="http://localhost:4000/2019/06/20/js-event-loop" />
<meta property="og:site_name" content="苏梓鑫的博客" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-20T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="JavaScript 事件循环" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2019/06/20/js-event-loop","headline":"JavaScript 事件循环","dateModified":"2019-06-20T00:00:00+08:00","datePublished":"2019-06-20T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/06/20/js-event-loop"},"description":"JavaScript 运行机制以及堆栈的详细描述","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
    <header>
        <nav class="top-nav">
            
            <div class="nav-wrapper">
                <div class="container">
                    
                    <a class="page-title" href="/">苏梓鑫的博客</a>
                    <p class="head-message">学习&nbsp;&nbsp;总结&nbsp;&nbsp;分享&nbsp;&nbsp;提升</p>
                </div>
            </div>
        </nav>

        <div class="container">
            <a href="#" data-target="slide-out" class="sidenav-trigger top-nav full hide-on-large-only">
                <i class="material-icons">menu</i>
            </a>
        </div>
        <ul id="slide-out" class="sidenav sidenav-fixed" style="background-color:#ddd">
            <li>
                <div class="userView">
                    <img class="user-bg" src="/assets/img/bg.png" />
                    <a class="user-avatar" href="https://github.com/suzixin" target="_blank">
                        <img class="circle z-depth-2" src="/assets/img/user.png" width="64" />
                    </a>
                    <div class="white-text user-info">
                        苏梓鑫 <i>(Knight Huang)</i><br>
                        adahsuzixin@gmail.com
                    </div>
                </div>
            </li>
            <li><a class="waves-effect" href="/"><i class="material-icons">home</i>Home - 主页</a></li>
            <li><a class="waves-effect" href="/projects"><i class="material-icons">description</i>Github - 项目</a></li>
            <li><a class="waves-effect" href="/categories"><i class="material-icons">sort</i>Categories - 目录</a></li>
            <li><a class="waves-effect" href="/tags"><i class="material-icons">label</i>Tags - 标签</a></li>
            <li><a class="waves-effect" href="/feed.xml" target="_blank"><i class="material-icons">rss_feed</i>RSS - 订阅</a></li>
            <li><a class="waves-effect" href="/about"><i class="material-icons">person</i>About - 关于我</a></li>
            <li><a class="waves-effect" href="/contact"><i class="material-icons">email</i>Contact - 联系我</a></li>
            <!-- 华为云广告 -->
            <li class="ad">
                <!-- <a href="https://mp.weixin.qq.com/s/ujUoHc3grjO8LD_Bg1fckA" target="_blank"> -->
                <!-- <a href="https://mp.weixin.qq.com/s/MTbMlhjAx8R4fc8Po90EXg" target="_blank">
                    <img src="/assets/img/ad-huaweiyun.png" alt="" width="100%" />
                </a>
                <i class="material-icons" onclick="javascript:this.parentNode.style.display='none';">close</i> -->
            </li>
        </ul>
    </header>
    <main>

<div class="container">
    <div id="page-info">
        <h1 class="page-title white-text">JavaScript 事件循环</h1>
    </div>
    <div id="page-content" class="row">
        <div id="post-info">
    <ul class="collapsible hoverable" data-collapsible="accordion">
        <li>
            <div class="collapsible-header grey lighten-4">
                <span>
                    <i class="material-icons tooltipped" data-position="left" data-delay="30" data-tooltip="Date">date_range</i>
                    20/06/2019 00:00<br />
                    <div id="busuanzi_container_site_pv">点击量：<span style="display: inline;" id="busuanzi_value_page_pv"></span>次</div>
                    <i id="indicate" class="right material-icons tooltipped" data-position="left" data-delay="30"
                        data-tooltip="Show extra info">info</i>
                </span>
            </div>
            <div class="collapsible-body">
                <span>
                    <i class="material-icons tooltipped" data-position="left" data-delay="30" data-tooltip="Categories">sort</i>
                    
                    
                    
                    <a href="/categories#javascript_cap"
                        target="_blank">
                        <div class="chip">JavaScript</div>
                    </a>
                    
                </span>
                <span>
                    <i class="material-icons tooltipped" data-position="left" data-delay="30" data-tooltip="Tags">label</i>
                    
                    
                    
                    <a href="/tags#event-loop" target="_blank">
                        <div class="chip">event-loop</div>
                    </a>
                    
                    
                    
                    <a href="/tags#事件循环_cap" target="_blank">
                        <div class="chip">事件循环</div>
                    </a>
                    
                    
                    
                    <a href="/tags#堆栈_cap" target="_blank">
                        <div class="chip">堆栈</div>
                    </a>
                    
                    
                    
                    <a href="/tags#宏任务_cap" target="_blank">
                        <div class="chip">宏任务</div>
                    </a>
                    
                    
                    
                    <a href="/tags#微任务_cap" target="_blank">
                        <div class="chip">微任务</div>
                    </a>
                    
                </span>
            </div>
        </li>
    </ul>
</div>
<div class="divider"></div>
<div id="post-content" class="row">
    <div class="col s12">
        <h1 id="运行时runtime">运行时（runtime）</h1>

<p>一个 JavaScript 运行时包含 <strong>栈(stack), 堆(heap), 队列(queue)</strong>;</p>

<h1 id="栈-stack">栈 (stack)</h1>

<p><strong>栈</strong> 具有 <strong>先进后出 (FILO, First In Last Out)</strong> 的特点，有时也叫做 <strong>堆栈</strong>，可以理解为一个开口向上的容器，先进入的物体压瓶底，后进入的物体一层层向上堆叠，最后取出时，也是一个个拿出来，先拿出最后放进去的，也就是在最上面那个，最后拿出的就是之前第一个放入瓶底的物体；其中容器里的每一个物体叫做 <strong>栈帧</strong>，理解为动画的每一帧，即最小单元；</p>

<p>动画描述：</p>

<p><img src="https://i.loli.net/2019/06/19/5d0a3c772749842497.gif" alt="stack_null.gif" /></p>

<p>JavaScript 执行时，每一个调用函数执行时会被压入栈中，称为 <strong>压栈</strong>，这个函数执行完毕后从栈中弹出，称为 <strong>弹栈</strong>；即某个物体放入容器一定时间后，再从容器里面取出来，方便为下一次放入物体腾出空间；</p>

<p>例如：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">fn1</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 1.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 0.</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">fn1</span><span class="p">();</span>

<span class="c1">// Message 0.</span>
<span class="c1">// Message 1.</span>
</code></pre></div></div>

<p>如果一个函数执行时还会调用第二个函数，那么第一个函数压入栈底后，随后第二个函数便会压在第一个上面，如果还存在第三个、第四个等等，便以此类推向上堆叠，直到最后调用的一个函数执行完之后，在从后往前一次弹出每一个函数；</p>

<p>可以理解为容器放入第一个物体后，本来应该随后取出的，但是这个物体又牵连了第二个物体，所以又继续放入第二个，甚至第三个、第四个等等；</p>

<p>例如：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">fn1</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 1.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">fn2</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fn1</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 2.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">fn3</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fn2</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 3.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 0.</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">fn3</span><span class="p">();</span>

<span class="c1">// Message 0.</span>
<span class="c1">// Message 1.</span>
<span class="c1">// Message 2.</span>
<span class="c1">// Message 3.</span>
<span class="c1">// 可以慢慢看几遍捋一下顺序</span>
</code></pre></div></div>

<p>演示动画：</p>

<p><img src="https://i.loli.net/2019/06/19/5d0a400b56afd25428.gif" alt="stack_fn.gif" /></p>

<p>到这里可能就有问题了，函数能无限调用下去？能无限向栈中压入物体？当然，这个容器是有限制的，例如，在电脑浏览器控制台输入以下代码：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span> <span class="nx">fn</span><span class="p">(){</span><span class="nx">fn</span><span class="p">()})()</span>
</code></pre></div></div>

<p>其实就是一个递归函数，不断调用自己，并且一直执行下去，那么不出意外，会弹出如下错误提示：</p>

<p><img src="https://i.loli.net/2019/06/18/5d08ec91b92e653156.png" alt="stack-exceed-fn.png" /></p>

<p>大致意思就是说执行栈发生了溢出，就是不断调用的函数太多了，超过了栈的规定大小；</p>

<p>也可以尝试输入以下代码，看一下使用的浏览器的栈的尺寸：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">(</span><span class="kd">function</span> <span class="nx">fn</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">);</span>
    <span class="nx">fn</span><span class="p">();</span>
<span class="p">})()</span>
</code></pre></div></div>

<p>回车之后，在浏览器没有卡死的情况下 -_-，n 分钟之后，应该会出现以下错误提示：</p>

<p><img src="https://i.loli.net/2019/06/18/5d08ecab407ee90019.png" alt="stack-exceed-num.png" /></p>

<p>最后一个出现的数字应该就是极限了，这里使用的是 Chrome 浏览器，可以看出还是比较大的；</p>

<h1 id="堆-heap">堆 (heap)</h1>

<p><strong>堆</strong> 在运行期间被用来动态分配内存，比如给变量、对象、数组、字符串等分配特定的内存地址，用以访问，不像栈和队列，它是一个非结构化的区域；</p>

<h1 id="队列-queue">队列 (queue)</h1>

<p><strong>队列</strong> 具有 <strong>先进先出 (FIFO, First In First Out)</strong> 的特点，这里就理解为排队取餐的一队人，先到先得，然后从前面先走，后来的排在最后，并且不允许插队；</p>

<p>在 JavaScript 运行时中，队列的结构被应用到了 <strong>消息队列</strong> 中；前面说到代码执行时，调用函数执行时被压入执行栈 (call stack) 中，并且需要等待该函数彻底执行完后，才能弹出栈，但是假如遇到 <code class="language-plaintext highlighter-rouge">setTimeout</code> 这样延时事件，由于 JavaScript 引擎的 <strong>单线程</strong> 特点，区别于其他语言，因此执行是不会因为延时函数而中断的，此时便会将 <code class="language-plaintext highlighter-rouge">setTimeout</code> 延时调用的函数放入 <strong>消息队列</strong> 中（延时短的早调用，延时长的晚调用，<strong>与书写顺序无关</strong>），等待当前环境所有压栈、弹栈操作执行完毕，再按照顺序执行队列中的调用函数；</p>

<p>例如：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">fn1</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 1.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">fn2</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fn1</span><span class="p">();</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="nx">delay1</span><span class="p">(){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 2.</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">fn3</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fn2</span><span class="p">();</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="nx">delay2</span><span class="p">(){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 2.5.</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 3.</span><span class="dl">'</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message 0.</span><span class="dl">'</span><span class="p">)</span>
<span class="nx">fn3</span><span class="p">();</span>

<span class="c1">// Message 0.</span>
<span class="c1">// Message 1.</span>
<span class="c1">// Message 3.</span>
<span class="c1">// Message 2.</span>
<span class="c1">// Message 2.5. (大约 1 秒后)</span>
</code></pre></div></div>

<p>动画演示：</p>

<p><img src="https://i.loli.net/2019/06/19/5d0a53f02b34680755.gif" alt="stack_fn_queue.gif" /></p>

<p>这里的结果就明显与之前的例子不同了，根据上面的描述，顺序为：</p>
<ul>
  <li>输出 <code class="language-plaintext highlighter-rouge">Message 0.</code>；</li>
  <li><code class="language-plaintext highlighter-rouge">fn3()</code> 压入栈底；</li>
  <li>然后压入 <code class="language-plaintext highlighter-rouge">fn2()</code>；</li>
  <li>最后压入 <code class="language-plaintext highlighter-rouge">fn1()</code>；</li>
  <li><code class="language-plaintext highlighter-rouge">fn1()</code> 内的语句执行完后，输出 <code class="language-plaintext highlighter-rouge">Message 1.</code>；</li>
  <li>执行函数 <code class="language-plaintext highlighter-rouge">fn2()</code> 的语句；</li>
  <li>由于 <code class="language-plaintext highlighter-rouge">fn2()</code> 内的 <code class="language-plaintext highlighter-rouge">setTimeout()</code> 函数是一个延时函数，所以其调用函数 <code class="language-plaintext highlighter-rouge">delay1()</code> 就被放到了消息队列中；</li>
  <li>然后执行 <code class="language-plaintext highlighter-rouge">fn3()</code> 中的 <code class="language-plaintext highlighter-rouge">setTiemout()</code>，其调用函数 <code class="language-plaintext highlighter-rouge">delay2()</code> 也被放入了队列中；</li>
  <li>由于 <code class="language-plaintext highlighter-rouge">delay1()</code> 的延时小于 <code class="language-plaintext highlighter-rouge">delay2()</code>，所以 <code class="language-plaintext highlighter-rouge">delay2()</code> 被放到了 <code class="language-plaintext highlighter-rouge">delay()</code> 的后面，反之颠倒顺序；</li>
  <li>输出 <code class="language-plaintext highlighter-rouge">fn3()</code> 中的 <code class="language-plaintext highlighter-rouge">Message 3.</code>；</li>
  <li>此时开始执行消息队列的函数；</li>
  <li>先执行 <code class="language-plaintext highlighter-rouge">delay1()</code> 输出 <code class="language-plaintext highlighter-rouge">Message 2.</code>；</li>
  <li>然后执行 <code class="language-plaintext highlighter-rouge">delay2()</code> 输出 <code class="language-plaintext highlighter-rouge">Message 2.5</code>；</li>
</ul>

<p><strong>注意</strong>，即使 <code class="language-plaintext highlighter-rouge">delay1()</code> 的延时为 <code class="language-plaintext highlighter-rouge">0</code>，也并不意味着该回调函数会在 0 毫秒后执行，即不会立即执行，由于机制原因，同样会被放入消息队列中，只不过会 <strong>比较早执行</strong> 而已；</p>

<h1 id="事件循环-event-loop">事件循环 (Event Loop)</h1>

<p>所谓事件循环，大致就是上诉过程；这里的 <strong>事件</strong> 指的就是消息队列中的消息，即队列中的调用函数；<strong>循环</strong> 即不断执行完队列中的消息，并等待是否有新消息到达，进而将其执行的这一循环过程；</p>

<h1 id="宏任务微任务">宏任务/微任务</h1>

<p>由于 JavaScript 的执行是<strong>单线程</strong>的（浏览器是多线程的），所以为了避免代码执行时遇到一些耗时的操作阻塞后续操作，就有了<strong>同步任务</strong>和<strong>异步任务</strong>之分；在 js 执行期间，遇到同步任务就执行<strong>入栈</strong>操作，遇到异步任务就放入<strong>队列</strong>中，栈中的同步任务执行完后再执行队列中的异步任务，也就是上面说的事件循环，这样就避免了耗时任务对栈中主线程的阻塞，一般大多数函数和变量声明都是同步任务，异步任务占少数如 <code class="language-plaintext highlighter-rouge">setTimeout()</code>, <code class="language-plaintext highlighter-rouge">setInterval()</code>, <code class="language-plaintext highlighter-rouge">Promise()</code> 等；其中，异步任务又可分为<strong>宏任务</strong>和<strong>微任务</strong>；</p>

<p>宏任务常见的有 <code class="language-plaintext highlighter-rouge">setTimeout()</code>, <code class="language-plaintext highlighter-rouge">setInterval()</code>，微任务常见的便是 <code class="language-plaintext highlighter-rouge">Promise()</code> 和 <code class="language-plaintext highlighter-rouge">process.nextTick()</code>（nodejs 中使用）；之前只提到消息队列，这里为了便于理解可以把宏任务和微任务看成两个分开的队列：宏任务队列与微任务队列；</p>

<p>我们通过以下代码看一下同步任务、宏任务、微任务的执行顺序：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Sync task.</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Macro task.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">Micro task.</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">End.</span><span class="dl">'</span><span class="p">);</span>
<span class="c1">// Sync task.</span>
<span class="c1">// End.</span>
<span class="c1">// Micro task.</span>
<span class="c1">// Macro task.</span>
</code></pre></div></div>

<p>接下来我们把宏任务和微任务的顺序换一下，再看一下结果：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Sync task.</span><span class="dl">'</span><span class="p">);</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">Micro task.</span><span class="dl">'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>

<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Macro task.</span><span class="dl">'</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">End.</span><span class="dl">'</span><span class="p">);</span>
<span class="c1">// Sync task.</span>
<span class="c1">// End.</span>
<span class="c1">// Micro task.</span>
<span class="c1">// Macro task.</span>
</code></pre></div></div>

<p>综合结果证明，任务的执行顺序是：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>同步任务 --&gt; 微任务 --&gt; 宏任务
</code></pre></div></div>

<p>再考虑下面这个较有代表性的稍微复杂点的嵌套情况（答案在代码最右侧，先思考再检查）：</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>

    <span class="nx">resolve</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>                                                                                                                                 <span class="c1">// 0  </span>
                                                                                                                                   <span class="c1">// 3  </span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>                                                                                                                 <span class="c1">// 9  </span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>                                                                                                                <span class="c1">// 5  </span>
<span class="p">},</span> <span class="mi">200</span><span class="p">)</span>                                                                                                                            <span class="c1">// 2  </span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>                                                                                                                 <span class="c1">// 8  </span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>                                                                                                                <span class="c1">// 6  </span>
<span class="p">},</span> <span class="mi">0</span><span class="p">)</span>                                                                                                                              <span class="c1">// 7  </span>
                                                                                                                                   <span class="c1">// 4  </span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>                                                                                                                    <span class="c1">// 1  </span>
</code></pre></div></div>

<p>查看答案后看看结果和预想的是否一致；可能唯一有疑惑的地方就是 <strong>3</strong> 和 <strong>9</strong> 的输出顺序，因为前面不是讲同步任务会先于 Promise 微任务执行吗？应该是 <strong>9</strong> 在 <strong>3</strong> 前面才对呀？其实不然，并不是在 Promise 函数代码内的都是微任务，因为所谓 <strong>微任务</strong> 就是一项任务，即指令下达后要做的事情，那么在函数中 <strong>要做的事</strong> 其实是 <code class="language-plaintext highlighter-rouge">.then()</code> 中包裹的代码，而 Promise 函数中包裹的代码（输出 <strong>3</strong>、<strong>4</strong>、<strong>5</strong>）算作 <strong>同步任务</strong> 的一部分，所以 <strong>3</strong> 会先于 <strong>9</strong> 输出；</p>

<p>另外，我们还能注意到，输出 <strong>6</strong> 的代码被 <code class="language-plaintext highlighter-rouge">setTimeout</code> 这个宏任务包裹，但这个宏任务又被 <code class="language-plaintext highlighter-rouge">.then()</code> 这个微任务包裹，根据最终的结果，这个宏任务基本还是被正常对待，只是在相同延时的宏任务中被最后执行了，尽管在代码中这个微任务中的宏任务写在了普通宏任务的前面，所以最终 <strong>8</strong> 会比 <strong>6</strong> 先输出；</p>

    </div>
</div>
<hr>

<!-- valine 评论插件 -->
<h3>评论：</h3>
<div class="comments"></div>
<hr>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '.comments',
        appId: '4XY3DoTJmibNe3rHeAKOxqzl-gzGzoHsz',
        appKey: 'vjothQHALvgTQF9GrSgj577a',
        avatar: 'robohash',
        placeholder: '留下你的评论吧（支持Markdown）~',
        // visitor: true,
    })
</script>

<!-- 微信公众号 -->
<div class="program-knight">
    <p>技术文章推送</p>
    <p>手机、电脑实用软件分享</p>
    <img src="/assets/img/knight.png" alt="微信搜索公众号: 程序骑士" title="微信搜索公众号: 程序骑士">
    <div>
        <img src="/assets/img/wechat.png" alt="wechat">
        <b>微信公众号：程序骑士</b>
    </div>
</div>
<!--百度资源自动提交-->


    </div>
</div>

</main>

<footer class="page-footer teal">
    <div class="container">
        <div class="row">
            <div class="col s12">
                <p class="footer-message grey-text text-lighten-3">以勤劳的双手，用心敲写明天</p>
                <hr>
                <p class="visit-statistics">
                    <span id="busuanzi_container_site_pv">访问量：<span id="busuanzi_value_site_pv"></span>次</span>&nbsp;
                    <span id="busuanzi_container_site_pv">访客量：<span id="busuanzi_value_site_uv"></span>人次</span>
                </p>
                <p class="grey-text text-lighten-4">基于 jekyll 的 Github Pages 个人博客网站
</p>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            Copyright &#xA9; 2021 苏梓鑫的博客. All rights reserved. Powered by
            <a href=https://github.com/suzixin/suzixin.github.io>knightyun</a>.
        </div>
    </div>
    <!-- Search box -->
    <div class="search">
        <i class="material-icons search-icon search-start">search</i>
        <input type="text" class="search-input" placeholder="Searching...（支持正则表达式）" />
        <i class="material-icons search-icon search-clear">clear</i>
        <div class="search-results z-depth-4"></div>
    </div>
    <!-- 右下角功能按钮 -->
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large blue z-depth-4">
            <i class="large material-icons">apps</i>
        </a>
        <ul>
            <li class="category-btn hide">
                <!-- 文章目录按钮 -->
                <a class="sidenav-trigger btn-floating blue lighten-2" data-target="category">
                    <i class="material-icons">format_list_bulleted</i>
                </a>
            </li>
            <li>
                <a class="btn-floating blue lighten-2" href="javascript: searchInput.focus()">
                    <i class="material-icons">search</i>
                </a>
            </li>
            <li>
                <a class="btn-floating blue lighten-2" href="javascript: scrollTo(0, 0);">
                    <i class="material-icons">publish</i>
                </a>
            </li>
            <li>
                <a class="btn-floating blue lighten-2" href="javascript: scrollTo(0, document.body.clientHeight);">
                    <i class="material-icons">file_download</i>
                </a>
            </li>
        </ul>
    </div>
    <!-- 文章目录侧栏 -->
    <ul id="category" class="hide sidenav no-autoinit grey lighten-4 grey-text text-darken-3">
        <li>
            <p class="center-align">目录</p>
        </li>
    </ul>
</footer>


    
    <script src="/assets/js/min/materialize.min.js"></script>
    

    
    <script src="/assets/js/min/post.min.js"></script>
    

    
    <script src="/assets/js/min/particles.min.js"></script>
    

    
    <script src="/assets/js/min/main.min.js"></script>
    

    
    <script src="/assets/js/min/search.min.js"></script>
    

    
    <script src="/assets/js/min/gen-category.min.js"></script>
    




<!-- 以下为插入的第三方网站分析代码 -->

</body>

</html>