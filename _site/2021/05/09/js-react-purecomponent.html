<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
    <meta http-equiv="Content-Language" content="zh-CN" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- 360 -->
    <meta name="360-site-verification" content="fa6ca3a9a0330e9cecabee0a9fe1d52a" />
    <!-- 搜狗 -->
    <meta name="sogou_site_verification" content="oatSp9uAV5" />
    <!--熊掌号 -->
    <meta name="baidu-site-verification" content="Wkb0Jzk8yx" />
    <!-- Google Search Console -->
    <meta name="google-site-verification" content="IJrXvaK-Luj-lCGP7tymcCbkcfMKi82Y8V21qN9ZT0s" />
    <title>
        
            React 组件性能优化之 PureComponent 的使用
        
    </title>
    <link rel="shortcut icon" type="image/x-icon" href="/assets/img/favicon.ico">
    
    <link rel="stylesheet" href="/assets/css/materialize.min.css">
    <link rel="stylesheet" href="/assets/css/icons.css">
    

    
        
        <link rel="stylesheet" href="/assets/css/page.css">
        
    
        
        <link rel="stylesheet" href="/assets/css/post.css">
        
    
        
        <link rel="stylesheet" href="/assets/css/syntax.css">
        
    
        
        <link rel="stylesheet" href="/assets/css/article-category.css">
        
    

    
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">	
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="React 组件性能优化之 PureComponent 的使用" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="探究 React 中使用 PureComponent 的性能优化效果" />
<meta property="og:description" content="探究 React 中使用 PureComponent 的性能优化效果" />
<link rel="canonical" href="http://localhost:4000/2021/05/09/js-react-purecomponent" />
<meta property="og:url" content="http://localhost:4000/2021/05/09/js-react-purecomponent" />
<meta property="og:site_name" content="苏梓鑫的博客" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-09T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="React 组件性能优化之 PureComponent 的使用" />
<script type="application/ld+json">
{"url":"http://localhost:4000/2021/05/09/js-react-purecomponent","headline":"React 组件性能优化之 PureComponent 的使用","dateModified":"2021-05-09T00:00:00+08:00","datePublished":"2021-05-09T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/05/09/js-react-purecomponent"},"description":"探究 React 中使用 PureComponent 的性能优化效果","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
    <header>
        <nav class="top-nav">
            
            <div class="nav-wrapper">
                <div class="container">
                    
                    <a class="page-title" href="/">苏梓鑫的博客</a>
                    <p class="head-message">学习&nbsp;&nbsp;总结&nbsp;&nbsp;分享&nbsp;&nbsp;提升</p>
                </div>
            </div>
        </nav>

        <div class="container">
            <a href="#" data-target="slide-out" class="sidenav-trigger top-nav full hide-on-large-only">
                <i class="material-icons">menu</i>
            </a>
        </div>
        <ul id="slide-out" class="sidenav sidenav-fixed" style="background-color:#ddd">
            <li>
                <div class="userView">
                    <img class="user-bg" src="/assets/img/bg.png" />
                    <a class="user-avatar" href="https://github.com/suzixin" target="_blank">
                        <img class="circle z-depth-2" src="/assets/img/user.png" width="64" />
                    </a>
                    <div class="white-text user-info">
                        苏梓鑫 <i>(Knight Huang)</i><br>
                        adahsuzixin@gmail.com
                    </div>
                </div>
            </li>
            <li><a class="waves-effect" href="/"><i class="material-icons">home</i>Home - 主页</a></li>
            <li><a class="waves-effect" href="/projects"><i class="material-icons">description</i>Github - 项目</a></li>
            <li><a class="waves-effect" href="/categories"><i class="material-icons">sort</i>Categories - 目录</a></li>
            <li><a class="waves-effect" href="/tags"><i class="material-icons">label</i>Tags - 标签</a></li>
            <li><a class="waves-effect" href="/feed.xml" target="_blank"><i class="material-icons">rss_feed</i>RSS - 订阅</a></li>
            <li><a class="waves-effect" href="/about"><i class="material-icons">person</i>About - 关于我</a></li>
            <li><a class="waves-effect" href="/contact"><i class="material-icons">email</i>Contact - 联系我</a></li>
            <!-- 华为云广告 -->
            <li class="ad">
                <!-- <a href="https://mp.weixin.qq.com/s/ujUoHc3grjO8LD_Bg1fckA" target="_blank"> -->
                <!-- <a href="https://mp.weixin.qq.com/s/MTbMlhjAx8R4fc8Po90EXg" target="_blank">
                    <img src="/assets/img/ad-huaweiyun.png" alt="" width="100%" />
                </a>
                <i class="material-icons" onclick="javascript:this.parentNode.style.display='none';">close</i> -->
            </li>
        </ul>
    </header>
    <main>

<div class="container">
    <div id="page-info">
        <h1 class="page-title white-text">React 组件性能优化之 PureComponent 的使用</h1>
    </div>
    <div id="page-content" class="row">
        <div id="post-info">
    <ul class="collapsible hoverable" data-collapsible="accordion">
        <li>
            <div class="collapsible-header grey lighten-4">
                <span>
                    <i class="material-icons tooltipped" data-position="left" data-delay="30" data-tooltip="Date">date_range</i>
                    09/05/2021 00:00<br />
                    <div id="busuanzi_container_site_pv">点击量：<span style="display: inline;" id="busuanzi_value_page_pv"></span>次</div>
                    <i id="indicate" class="right material-icons tooltipped" data-position="left" data-delay="30"
                        data-tooltip="Show extra info">info</i>
                </span>
            </div>
            <div class="collapsible-body">
                <span>
                    <i class="material-icons tooltipped" data-position="left" data-delay="30" data-tooltip="Categories">sort</i>
                    
                    
                    
                    <a href="/categories#javascript_cap"
                        target="_blank">
                        <div class="chip">JavaScript</div>
                    </a>
                    
                </span>
                <span>
                    <i class="material-icons tooltipped" data-position="left" data-delay="30" data-tooltip="Tags">label</i>
                    
                    
                    
                    <a href="/tags#react" target="_blank">
                        <div class="chip">react</div>
                    </a>
                    
                    
                    
                    <a href="/tags#purecomponent" target="_blank">
                        <div class="chip">purecomponent</div>
                    </a>
                    
                    
                    
                    <a href="/tags#性能优化_cap" target="_blank">
                        <div class="chip">性能优化</div>
                    </a>
                    
                    
                    
                    <a href="/tags#组件_cap" target="_blank">
                        <div class="chip">组件</div>
                    </a>
                    
                </span>
            </div>
        </li>
    </ul>
</div>
<div class="divider"></div>
<div id="post-content" class="row">
    <div class="col s12">
        <p>在 React 类组件中，如果状态（<code class="language-plaintext highlighter-rouge">state</code>）发生变化，便会触发组件的重新渲染（执行 <code class="language-plaintext highlighter-rouge">render</code> 方法），并且是包括所有子组件在内的全部重渲染，无论某些子组件是否有用到 <code class="language-plaintext highlighter-rouge">state</code> 中的值；但有些时候部分子组件计算或渲染工作量较大，并且只做一些情况单一的展示工作，那么在更新状态时对其的渲染，便是额外的性能负担，所以需要寻求一些优化手段；</p>

<h2 id="shouldcomponentupdate">shouldComponentUpdate</h2>

<p><code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> 是 React 的生命周期函数之一，它会在每次渲染（<code class="language-plaintext highlighter-rouge">render</code>）之前被调用，并且根据该函数的返回值（<code class="language-plaintext highlighter-rouge">true</code>/<code class="language-plaintext highlighter-rouge">false</code>）来决定是否调用渲染函数（<code class="language-plaintext highlighter-rouge">return true</code> 触发渲染，<code class="language-plaintext highlighter-rouge">return false</code> 阻止渲染），但是组件的首次渲染或者调用 <code class="language-plaintext highlighter-rouge">forceUpdate()</code> 方法时<strong>不会</strong>触发调用 <code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> 方法；该生命周期函数的<strong>默认行为</strong>是在每次 <code class="language-plaintext highlighter-rouge">state</code> 发生变化时触发重新渲染，如果自行声明该函数会<strong>覆盖</strong>这一默认行为，需要自行判断 <code class="language-plaintext highlighter-rouge">state</code> 的变化以决定是否重新渲染；</p>

<p><code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> 方法接收两个传参：<code class="language-plaintext highlighter-rouge">(nextProps, nextState)</code>，分别表示变化后的 <code class="language-plaintext highlighter-rouge">props</code>（组件的参数） 和 <code class="language-plaintext highlighter-rouge">state</code>（组件的状态）；</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">MyComponent</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span> <span class="na">count</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="nx">shouldComponentUpdate</span><span class="p">(</span><span class="nx">nextProps</span><span class="p">,</span> <span class="nx">nextState</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 无需手动更新 state 值，组件会自动更新</span>
    <span class="c1">// this.setState({ ...nextState });</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">nextState</span><span class="p">.</span><span class="nx">count</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// count 值大于 3 后，组件便不再更新</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">count</span><span class="p">:</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">})}</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="nx">count</span><span class="p">}</span>
      <span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="purecomponent">PureComponent</h2>

<p><code class="language-plaintext highlighter-rouge">React.PureComponent</code> 类似于我们常用的 <code class="language-plaintext highlighter-rouge">React.Component</code>，区别在于 <code class="language-plaintext highlighter-rouge">PureComponent</code> 的内置 <code class="language-plaintext highlighter-rouge">shouldComponentUpdate</code> 逻辑，它会同时对 <code class="language-plaintext highlighter-rouge">props</code> 和 <code class="language-plaintext highlighter-rouge">state</code> 的变化前和变化后的值进行<strong>浅对比</strong>，如果都没发生变化则会跳过重渲染，相当于多了一层 <code class="language-plaintext highlighter-rouge">props</code> 对比；下面通过一个简单的例子来对比这两种组件的效果差异；</p>

<h3 id="效果对比">效果对比</h3>

<p>假设有一个计数器，点击按钮增加计数，并用两种组件渲染计数值：</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Counter</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span> <span class="na">count</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">style</span><span class="o">=&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">count</span><span class="p">:</span> <span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">CountText</span> <span class="nx">count</span><span class="o">=</span><span class="p">{</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">?</span> <span class="nx">count</span> <span class="p">:</span> <span class="mi">0</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">ConstText</span> <span class="nx">count</span><span class="o">=</span><span class="p">{</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">?</span> <span class="nx">count</span> <span class="p">:</span> <span class="mi">0</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">count</span><span class="p">:</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">})}</span><span class="o">&gt;</span><span class="nx">Add</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 普通组件</span>
<span class="kd">class</span> <span class="nx">CountText</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">normal rendered</span><span class="dl">'</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">normal</span><span class="p">:</span> <span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">;
</span>  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// “纯”组件</span>
<span class="kd">class</span> <span class="nx">ConstText</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">PureComponent</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">pure rendered</span><span class="dl">'</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">pure</span><span class="p">:</span> <span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">;
</span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>初次渲染的效果图与输出如下，页面初始化时普通组件与纯组件都会进行一次渲染：</p>

<p><img src="https://img-blog.csdnimg.cn/20210509121150531.png" alt="1" /></p>

<p>第一次和第二次点击按钮后，可以看到都只有普通组件触发了渲染，即使组件每次接收的 <code class="language-plaintext highlighter-rouge">props</code> 值 <code class="language-plaintext highlighter-rouge">count</code> 都没有发生变化：</p>

<p><img src="https://img-blog.csdnimg.cn/20210509121240758.png" alt="2" /></p>

<p><img src="https://img-blog.csdnimg.cn/20210509125010295.png" alt="3" /></p>

<p>在第三次点击按钮后，由于 <code class="language-plaintext highlighter-rouge">props</code> 的传入值发生了改变，因此纯组件也触发了重渲染，页面内容正常更新：</p>

<p><img src="https://img-blog.csdnimg.cn/20210509125340917.png" alt="4" /></p>

<h3 id="子组件更新问题">子组件更新问题</h3>

<p>可以看到 <code class="language-plaintext highlighter-rouge">PureComponent</code> 确实可以在传入 <code class="language-plaintext highlighter-rouge">props</code> 值没有变化时避免重新渲染，在一些场景下优化性能，但是这也是使用 <code class="language-plaintext highlighter-rouge">PureComponent</code> 的一个前提，即需要组件在相同 <code class="language-plaintext highlighter-rouge">props</code> 传入值的情况下总会有相同的渲染内容，也就是纯组件中 <code class="language-plaintext highlighter-rouge">Pure</code> 的含义所在，它有些类似<strong>纯函数</strong>的定义（传入相同的参数执行后，总会得到相同的返回值）；</p>

<p>从另一个方面来说，就是 <code class="language-plaintext highlighter-rouge">PureComponent</code> 跳过渲染时，它的所有<strong>子组件</strong>也会跳过渲染，即使子组件应被更新，所以需要保证纯组件的所有子组件也都是纯组件；举个例子，下面的纯组件包含一个展示当前时间的子组件：</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Counter</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span> <span class="na">count</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">style</span><span class="o">=&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">count</span><span class="p">:</span> <span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">ConstText</span> <span class="nx">count</span><span class="o">=</span><span class="p">{</span><span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">?</span> <span class="nx">count</span> <span class="p">:</span> <span class="mi">0</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">count</span><span class="p">:</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">})}</span><span class="o">&gt;</span><span class="nx">Add</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// “纯”组件</span>
<span class="kd">class</span> <span class="nx">ConstText</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">PureComponent</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()}</span><span class="s2">: </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()}</span><span class="s2">: </span><span class="p">${</span><span class="nx">d</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">()}</span><span class="s2">`</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">pure rendered</span><span class="dl">'</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="nx">pure</span><span class="p">:</span> <span class="p">{</span><span class="nx">count</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="nx">ConstChild</span> <span class="nx">time</span><span class="o">=</span><span class="p">{</span><span class="nx">time</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 展示时间的子组件</span>
<span class="kd">class</span> <span class="nx">ConstChild</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">time</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">child rendered</span><span class="dl">'</span><span class="p">,</span> <span class="nx">time</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">time</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>页面初始化时：</p>

<p><img src="https://img-blog.csdnimg.cn/20210509133437250.png" alt="5" /></p>

<p>前两次点击按钮后：</p>

<p><img src="https://img-blog.csdnimg.cn/20210509133505131.png" alt="6" /></p>

<p><img src="https://img-blog.csdnimg.cn/20210509133522526.png" alt="7" /></p>

<p>此时纯组件和其子组件都未触发更新，在第三次点击后，才同时触发更新：</p>

<p><img src="https://img-blog.csdnimg.cn/20210509133559596.png" alt="8" /></p>

<h3 id="浅对比问题">浅对比问题</h3>

<p>最开始有提到 <code class="language-plaintext highlighter-rouge">PureComponent</code> 是对 <code class="language-plaintext highlighter-rouge">props</code> 的变化前后的值进行浅对比来决定是否重渲染组件，实际上就是对每个 <code class="language-plaintext highlighter-rouge">props</code> 值进行基本的值对比，如果值类型是复杂类型，如引用类型（对象），并不会深入遍历每个属性的变化，下面改造一下上面的示例，让传入纯组件的 <code class="language-plaintext highlighter-rouge">props</code> 变成一个引用对象：</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Counter</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span> <span class="na">count</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>
  <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="na">num</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">};</span>

  <span class="nx">handleAdd</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">newCount</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">count</span><span class="p">:</span> <span class="nx">newCount</span> <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">.</span><span class="nx">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newCount</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Counter rendered</span><span class="dl">'</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">));</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">style</span><span class="o">=&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">count</span><span class="p">:</span> <span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">ConstText</span> <span class="nx">count</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleAdd</span><span class="p">()}</span><span class="o">&gt;</span><span class="nx">Add</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">ConstText</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">PureComponent</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="na">count</span><span class="p">:</span> <span class="p">{</span> <span class="na">num</span><span class="p">:</span> <span class="p">[</span><span class="nx">count</span><span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">pure rendered</span><span class="dl">'</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">pure</span><span class="p">:</span> <span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">;
</span>  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>首次初始化后的结果：</p>

<p><img src="https://img-blog.csdnimg.cn/20210509140040488.png" alt="9" /></p>

<p>依次点击三次后的结果：</p>

<p><img src="https://img-blog.csdnimg.cn/20210509140105603.png" alt="10" /></p>

<p><img src="https://img-blog.csdnimg.cn/20210509140144675.png" alt="11" /></p>

<p><img src="https://img-blog.csdnimg.cn/2021050914021458.png" alt="12" /></p>

<p>可以看到其实每次传入纯组件的 <code class="language-plaintext highlighter-rouge">props</code> 的实际值都有发生变化，但是由于是引用类型，所以组件并没有识别到这一变化，永远跳过了组件更新；因此如果遇到复杂数据结构的情况，尽量使用 <code class="language-plaintext highlighter-rouge">state</code>，因为 <code class="language-plaintext highlighter-rouge">state</code> 由于自身的特性和规则，每次变化后的值都是一个全新的值；</p>

<p>当然，还有一种特殊情况，如果在组件中使用了 <strong>Render prop</strong> 或类似的形式，即 <code class="language-plaintext highlighter-rouge">props</code> 的值是一个返回某个值的函数，如：</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">Counter</span> <span class="nx">count</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span></code></pre></div></div>

<p>那么即使每次函数实际执行的值都是相同的，也都会触发渲染，因为这个函数本身每次都会被判断为一个<strong>新值</strong>，使得性能优化<strong>失效</strong>；</p>

<h2 id="reactmemo">React.memo</h2>

<p><code class="language-plaintext highlighter-rouge">React.memo</code> 是一个类似 <code class="language-plaintext highlighter-rouge">PureComponent</code> 的高阶组件，只不过它用于<strong>函数组件</strong>，而 <code class="language-plaintext highlighter-rouge">PureComponent</code> 用于类（<code class="language-plaintext highlighter-rouge">class</code>）组件，但二者的实际展示与优化效果是一致的，下面是两种组件形式的写法：</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 类组件</span>
<span class="kd">class</span> <span class="nx">ConstText1</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">PureComponent</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">pure rendered</span><span class="dl">'</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="nx">pure</span><span class="p">:</span> <span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div&gt;</span><span class="err">;
</span>  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 函数组件</span>
<span class="kd">const</span> <span class="nx">ConstText2</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">memo</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">count</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">const rendered</span><span class="dl">'</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="p">});</span>
</code></pre></div></div>

    </div>
</div>
<hr>

<!-- valine 评论插件 -->
<h3>评论：</h3>
<div class="comments"></div>
<hr>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '.comments',
        appId: '4XY3DoTJmibNe3rHeAKOxqzl-gzGzoHsz',
        appKey: 'vjothQHALvgTQF9GrSgj577a',
        avatar: 'robohash',
        placeholder: '留下你的评论吧（支持Markdown）~',
        // visitor: true,
    })
</script>

<!-- 微信公众号 -->
<div class="program-knight">
    <p>技术文章推送</p>
    <p>手机、电脑实用软件分享</p>
    <img src="/assets/img/knight.png" alt="微信搜索公众号: 程序骑士" title="微信搜索公众号: 程序骑士">
    <div>
        <img src="/assets/img/wechat.png" alt="wechat">
        <b>微信公众号：程序骑士</b>
    </div>
</div>
<!--百度资源自动提交-->


    </div>
</div>

</main>

<footer class="page-footer teal">
    <div class="container">
        <div class="row">
            <div class="col s12">
                <p class="footer-message grey-text text-lighten-3">以勤劳的双手，用心敲写明天</p>
                <hr>
                <p class="visit-statistics">
                    <span id="busuanzi_container_site_pv">访问量：<span id="busuanzi_value_site_pv"></span>次</span>&nbsp;
                    <span id="busuanzi_container_site_pv">访客量：<span id="busuanzi_value_site_uv"></span>人次</span>
                </p>
                <p class="grey-text text-lighten-4">基于 jekyll 的 Github Pages 个人博客网站
</p>
            </div>
        </div>
    </div>
    <div class="footer-copyright">
        <div class="container">
            Copyright &#xA9; 2021 苏梓鑫的博客. All rights reserved. Powered by
            <a href=https://github.com/suzixin/suzixin.github.io>knightyun</a>.
        </div>
    </div>
    <!-- Search box -->
    <div class="search">
        <i class="material-icons search-icon search-start">search</i>
        <input type="text" class="search-input" placeholder="Searching...（支持正则表达式）" />
        <i class="material-icons search-icon search-clear">clear</i>
        <div class="search-results z-depth-4"></div>
    </div>
    <!-- 右下角功能按钮 -->
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large blue z-depth-4">
            <i class="large material-icons">apps</i>
        </a>
        <ul>
            <li class="category-btn hide">
                <!-- 文章目录按钮 -->
                <a class="sidenav-trigger btn-floating blue lighten-2" data-target="category">
                    <i class="material-icons">format_list_bulleted</i>
                </a>
            </li>
            <li>
                <a class="btn-floating blue lighten-2" href="javascript: searchInput.focus()">
                    <i class="material-icons">search</i>
                </a>
            </li>
            <li>
                <a class="btn-floating blue lighten-2" href="javascript: scrollTo(0, 0);">
                    <i class="material-icons">publish</i>
                </a>
            </li>
            <li>
                <a class="btn-floating blue lighten-2" href="javascript: scrollTo(0, document.body.clientHeight);">
                    <i class="material-icons">file_download</i>
                </a>
            </li>
        </ul>
    </div>
    <!-- 文章目录侧栏 -->
    <ul id="category" class="hide sidenav no-autoinit grey lighten-4 grey-text text-darken-3">
        <li>
            <p class="center-align">目录</p>
        </li>
    </ul>
</footer>


    
    <script src="/assets/js/min/materialize.min.js"></script>
    

    
    <script src="/assets/js/min/post.min.js"></script>
    

    
    <script src="/assets/js/min/particles.min.js"></script>
    

    
    <script src="/assets/js/min/main.min.js"></script>
    

    
    <script src="/assets/js/min/search.min.js"></script>
    

    
    <script src="/assets/js/min/gen-category.min.js"></script>
    




<!-- 以下为插入的第三方网站分析代码 -->

</body>

</html>